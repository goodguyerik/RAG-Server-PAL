{% extends "base.html" %}
{% block content %}

<style>
  /* --- Mobile card layout (shown < md) --- */
  .result-card { border:1px solid #ececec; border-radius:.8rem; }
  .result-card + .result-card { margin-top: .9rem; }
  .dot { width:12px; height:12px; border-radius:50%; display:inline-block; vertical-align:middle; }
  .idx-pill { display:inline-block; min-width:1.6rem; text-align:center; padding:.1rem .4rem; border-radius:.6rem; background:#f2f2f2; font-weight:600; }
  .btn-feedback { padding:.15rem .45rem; }
  .file-link { word-break: break-word; }

  /* --- Desktop/table layout (shown >= md) --- */
  @media (min-width:768px) {
    .results-header { color:#555; font-size:.9em; }
    .row-table { display:flex; align-items:center; font-size:.9em; }
    .col-idx   { width:40px; text-align:center; }
    .col-file  { flex:1; padding-left:15px; }
    .col-page  { width:80px; }
    .col-score { width:70px; text-align:center; }
    .col-fb    { width:160px; text-align:right; }
    .circle { width:20px; height:20px; border-radius:50%; margin:auto; }
  }
</style>

<div class="py-3">
  <h3 class="text-center mb-3">Bitte geben Sie Ihre Suchanfrage ein.</h3>

  <form method="POST" action="{{ url_for('search') }}" class="mb-3">
    <div class="form-group">
      <textarea class="form-control" id="query" name="query"
        placeholder="Wie kann ich die Gasart bei einem Warmlufterzeuger wechseln?"
        rows="3">{{ query or '' }}</textarea>
    </div>
    <button type="submit" class="btn btn-primary mb-2">Suche</button>
  </form>

  {% if results is defined %}
    <hr>
    {% if results|length == 0 %}
      <div class="alert alert-info">Keine Treffer gefunden!</div>
    {% else %}

    <form method="POST" action="{{ url_for('feedback') }}">
      <input type="hidden" name="log_id" value="{{ log_id }}">
      <input type="hidden" name="topk" value="{{ results|length }}">

      <!-- Desktop header -->
      <div class="d-none d-md-flex align-items-center results-header pb-2 mb-2 border-bottom">
        <div class="col-idx">#</div>
        <div class="col-file">Datei</div>
        <div class="col-page">Seite</div>
        <div class="col-score">Relevanz</div>
        <div class="col-fb">Feedback</div>
      </div>

      {% for idx, result in results %}
      {% set (doc_id, display_name, page, score, color, file_type, ts_seconds) = result %}

      <!-- MOBILE CARD (visible < md) -->
      <div class="card result-card shadow-sm d-md-none">
        <div class="card-body p-3">
          <div class="d-flex align-items-start">
            <div class="mr-2 idx-pill"># {{ keycaps[idx] }}</div>
            <div class="flex-grow-1">
              {% if file_type == 'video' %}
                <a class="file-link"
                   href="{{ url_for('video_player', filename=display_name, t=ts_seconds or 0) }}"
                   target="_blank" rel="noopener">
                   {{ display_name }}
                </a>
              {% else %}
                <!-- Serve both: query & fragment so raw-PDF and viewer both jump -->
                <a class="file-link"
                   href="{{ url_for('pdf_viewer', filename=display_name, page=page) }}#page={{ page }}"
                   target="_blank" rel="noopener">
                   {{ display_name }}
                </a>
              {% endif %}
            </div>
          </div>
          <div class="mt-2 small text-muted">
            Seite {{ page }} <span class="mx-2">¬∑</span>
            <span class="dot" style="background-color: {{ color }};"></span>
          </div>
          <div class="mt-2">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-outline-success btn-sm btn-feedback">
                <input type="radio" name="feedback_{{ idx }}" value="up" autocomplete="off"> üëç
              </label>
              <label class="btn btn-outline-danger btn-sm btn-feedback">
                <input type="radio" name="feedback_{{ idx }}" value="down" autocomplete="off"> üëé
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- DESKTOP ROW (visible >= md) -->
      <div class="row-table py-2 border-bottom d-none d-md-flex">
        <div class="col-idx"><span>{{ keycaps[idx] }}</span></div>
        <div class="col-file">
          {% if file_type == 'video' %}
            <a href="{{ url_for('video_player', filename=display_name, t=ts_seconds or 0) }}" target="_blank" rel="noopener">
              {{ display_name }}
            </a>
          {% else %}
            <!-- same double-target link -->
            <a href="{{ url_for('pdf_viewer', filename=display_name, page=page) }}#page={{ page }}"
               target="_blank" rel="noopener">
              {{ display_name }}
            </a>
          {% endif %}
        </div>
        <div class="col-page">Seite {{ page }}</div>
        <div class="col-score">
          <div class="circle" style="background-color: {{ color }};"></div>
        </div>
        <div class="col-fb">
          <div class="d-inline-flex align-items-center">
            <input type="radio" name="feedback_{{ idx }}" id="feedback_up_{{ idx }}" value="up">
            <span class="ml-1" style="font-size:1.2em;">üëç</span>
          </div>
          <div class="d-inline-flex align-items-center ml-3">
            <input type="radio" name="feedback_{{ idx }}" id="feedback_down_{{ idx }}" value="down">
            <span class="ml-1" style="font-size:1.2em;">üëé</span>
          </div>
        </div>
      </div>
      {% endfor %}

      <div class="form-group mt-3">
        <label for="comment">Anmerkungen (optional)</label>
        <textarea class="form-control" id="comment" name="comment"
          placeholder="Anmerkungen (optional)" rows="2"></textarea>
        <p class="small text-muted mb-0">
          Dieses Feedback dient zur Verbesserung des Systems. Bitte verwenden Sie keine pers√∂nlichen Daten.
        </p>
      </div>

      <button type="submit" class="btn btn-success">Feedback Abschicken</button>
    </form>

    {% endif %}
  {% else %}
    <style>
    .hero-logo { max-height: 500px; width: auto; }
    @media (min-width: 768px) { .hero-logo { max-height: 500px; } }
    </style>
    
    <img
      src="{{ url_for('static', filename='help/wini_gruss.PNG') }}"
      alt="{{ company_name }}"
      class="img-fluid hero-logo d-block mx-auto"
      loading="lazy" decoding="async"
    />

    <div class="text-center mt-4">
      <a
        href="{{ url_for('static', filename='help/Bedienungsanleitung WINI.pdf') }}"
        class="btn btn-outline-primary btn-sm"
        target="_blank" rel="noopener"
        title="Bedienungsanleitung WINI (PDF)"
      >
        Mehr Informationen
      </a>
    </div>
  {% endif %}
</div>
{% endblock %}