{% extends "base.html" %}
{% block content %}
  <h1>Dateien bearbeiten</h1>

  <form method="POST" action="{{ url_for('delete_all_pdfs') }}" class="mb-3">
    <button type="submit" class="btn btn-danger">Alle Dateien löschen</button>
  </form>

  <h3 class="mb-3">Verfügbare Dateien:</h3>

  {% if pdf_names %}
    <style>
    .file-row {
      display: grid;
      grid-template-columns: minmax(0,1fr) auto 22rem; /* title | delete | dropdown */
      gap: .75rem 1rem;
      align-items: center;
    }
    @media (max-width: 768px) {
      .file-row { grid-template-columns: minmax(0,1fr) auto; }
      .file-row .col-dropdown { grid-column: 1 / -1; justify-self: end; max-width: 100%; }
    }

    /* Make truncation actually work */
    .col-title { min-width: 0; }           /* allow shrinking inside grid */
    .truncate {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
    }

    /* Keep buttons from stretching layout */
    .btn-sm { white-space: nowrap; }

    /* Constrain dropdown width and ellipsize items */
    .conn-dropdown { max-width: 22rem; }
    .dropdown-menu {
      max-height: 50vh; overflow:auto;
      max-width: 22rem;
    }
    .dropdown-item.truncate { display:block; } /* bootstrap text-truncate needs block-ish */
  </style>


    <ul class="list-group">
      {% for pdf in pdf_names %}
        {% set conn_title, conn_items = connections(pdf) %}
        <li class="list-group-item">
          <div class="file-row">
            <!-- Title/link (left) -->
            <a href="{{ url_for('serve_pdf', filename=pdf) }}"
              target="_blank"
              class="col-title truncate"
              title="{{ pdf }}">
              {{ pdf }}
            </a>

            <!-- Delete (middle) -->
            <form method="POST" action="{{ url_for('delete_single_pdf', pdf=pdf) }}" class="m-0">
              <button type="submit" class="btn btn-sm btn-danger">Löschen</button>
            </form>

            <!-- Dropdown (right) -->
            <form method="POST" action="{{ url_for('establish_connection') }}"
                  class="m-0 col-dropdown conn-dropdown justify-self-end">
              <input type="hidden" name="source_pdf" value="{{ pdf }}">
              <div class="dropdown">
                {% if conn_items and conn_items|length > 0 %}
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle"
                          type="button"
                          data-bs-toggle="dropdown"
                          data-bs-display="static"
                          aria-expanded="false"
                          title="{{ conn_title }}">
                    <span class="truncate" style="max-width: 18rem; display:inline-block;">
                      {{ conn_title }}
                    </span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    {% for item in conn_items %}
                      <li>
                        <button class="dropdown-item truncate" type="submit"
                                name="target_pdf" value="{{ item }}"
                                title="{{ item }}">
                          {{ item }}
                        </button>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" disabled
                          title="Keine weiteren Verknüpfungen verfügbar">
                    <span class="truncate" style="max-width: 18rem; display:inline-block;">
                      {{ conn_title }}
                    </span>
                  </button>
                {% endif %}
              </div>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-info">Keine PDFs zum Löschen verfügbar.</div>
  {% endif %}
{% endblock %}